FROM ansibleplaybookbundle/apb-base:galaxy

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IGdhbGVyYS1yZXBsaWNhdGlvbi1hcGIKZGVzY3JpcHRpb246IERl\
cGxveSBHYWxlcmEgd2l0aCBhIFJlcGxpY2F0aW9uIE9wZXJhdG9yCmJpbmRhYmxlOiBUcnVlCmFz\
eW5jOiBvcHRpb25hbAptZXRhZGF0YToKICBkaXNwbGF5TmFtZTogcmVwbGljYXRpb24KcGxhbnM6\
CiAgLSBuYW1lOiBlcGhlbWVyYWwKICAgIGRlc2NyaXB0aW9uOiBUaGlzIHBsYW4gZGVwbG95cyBh\
biBlcGhlbWVyYWwgR2FsZXJhIGNsdXN0ZXIgb24gTGludXgKICAgIGZyZWU6IFRydWUKICAgIG1l\
dGFkYXRhOiB7fQogICAgcGFyYW1ldGVyczoKICAgICAgLSBuYW1lOiBhZG1pbl91c2VyCiAgICAg\
ICAgdGl0bGU6IE9wZW5zaGlmdCBBZG1pbiBVc2VyCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAg\
ICAgZGVmYXVsdDogZGV2ZWxvcGVyCiAgICAgICAgI3JlcXVpcmVkOiB0cnVlCiAgICAgIC0gbmFt\
ZTogYWRtaW5fcGFzc3dvcmQKICAgICAgICB0aXRsZTogT3BlbnNoaWZ0IEFkbWluIFBhc3N3b3Jk\
CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgZGlzcGxheV90eXBlOiBwYXNzd29yZAogICAg\
ICAgIGRlZmF1bHQ6IHBhc3N3b3JkCiAgICAgIC0gbmFtZTogc2VydmljZV9uYW1lCiAgICAgICAg\
ZGVzY3JpcHRpb246IFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlLiBVc2VkIHRvIG5hbWUgYW5kIGxh\
YmVsIHJlc291cmNlcwogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIGRlZmF1bHQ6IGdhbGVy\
YQogICAgICAgIHBhdHRlcm46ICJeW2EtekEtWjAtOV0rW2EtekEtWjAtOS1dKlthLXpBLVowLTld\
KyQiCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLSBuYW1lOiBzZXJ2aWNlX3JlcGxpY2Fz\
CiAgICAgICAgdGl0bGU6IE51bWJlciBvZiBkYXRhYmFzZSByZXBsaWNhcwogICAgICAgIHR5cGU6\
IG51bWJlcgogICAgICAgIGRlZmF1bHQ6IDMKICAgICAgLSBuYW1lOiBteXNxbF9kYXRhYmFzZQog\
ICAgICAgIGRlc2NyaXB0aW9uOiBUaGUgbmFtZSBvZiB0aGUgTXlTUUwgZGF0YWJhc2UKICAgICAg\
ICB0eXBlOiBzdHJpbmcKICAgICAgICBkZWZhdWx0OiBzYW1wbGUKICAgICAgICBwYXR0ZXJuOiAi\
XlthLXpBLVowLTlfXSpbYS16QS1aX10rW2EtekEtWjAtOV9dKiQiCiAgICAgICAgcmVxdWlyZWQ6\
IHRydWUKICAgICAgLSBuYW1lOiBteXNxbF91c2VyCiAgICAgICAgZGVzY3JpcHRpb246IFVzZXJu\
YW1lIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGNvbm5lY3QgdG8gTXlTUUwKICAgICAgICB0eXBlOiBz\
dHJpbmcKICAgICAgICBwYXR0ZXJuOiAiXlthLXpBLVowLTlfXSpbYS16QS1aX10rW2EtekEtWjAt\
OV9dKiQiCiAgICAgICAgZGVmYXVsdDogYWRtaW4KICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAg\
ICAtIG5hbWU6IG15c3FsX3Bhc3N3b3JkCiAgICAgICAgZGVzY3JpcHRpb246IFBhc3N3b3JkIHRv\
IGNvbm5lY3QgdG8gTXlTUUwgKGdlbmVyYXRlZCBpZiBibGFuaykKICAgICAgICB0eXBlOiBzdHJp\
bmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlfdHlwZTogcGFzc3dvcmQK\
ICAgICAgICBkZWZhdWx0OiBhZG1pbgogIC0gbmFtZTogcGVyc2lzdGVudAogICAgZGVzY3JpcHRp\
b246IFRoaXMgcGxhbiBkZXBsb3lzIGEgcGVyc2lzdGVudCBHYWxlcmEgY2x1c3RlciBvbiBMaW51\
eAogICAgZnJlZTogVHJ1ZQogICAgbWV0YWRhdGE6IHt9CiAgICBwYXJhbWV0ZXJzOgogICAgICAt\
IG5hbWU6IGFkbWluX3VzZXIKICAgICAgICB0aXRsZTogT3BlbnNoaWZ0IEFkbWluIFVzZXIKICAg\
ICAgICB0eXBlOiBzdHJpbmcKICAgICAgICBkZWZhdWx0OiBkZXZlbG9wZXIKICAgICAgICAjcmVx\
dWlyZWQ6IHRydWUKICAgICAgLSBuYW1lOiBhZG1pbl9wYXNzd29yZAogICAgICAgIHRpdGxlOiBP\
cGVuc2hpZnQgQWRtaW4gUGFzc3dvcmQKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICBkaXNw\
bGF5X3R5cGU6IHBhc3N3b3JkCiAgICAgICAgZGVmYXVsdDogcGFzc3dvcmQKICAgICAgLSBuYW1l\
OiBzZXJ2aWNlX25hbWUKICAgICAgICBkZXNjcmlwdGlvbjogVGhlIG5hbWUgb2YgdGhlIHNlcnZp\
Y2UuIFVzZWQgdG8gbmFtZSBhbmQgbGFiZWwgcmVzb3VyY2VzCiAgICAgICAgdHlwZTogc3RyaW5n\
CiAgICAgICAgZGVmYXVsdDogZ2FsZXJhCiAgICAgICAgcGF0dGVybjogIl5bYS16QS1aMC05XStb\
YS16QS1aMC05LV0qW2EtekEtWjAtOV0rJCIKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAt\
IG5hbWU6IHNlcnZpY2VfcmVwbGljYXMKICAgICAgICB0aXRsZTogTnVtYmVyIG9mIGRhdGFiYXNl\
IHJlcGxpY2FzCiAgICAgICAgdHlwZTogbnVtYmVyCiAgICAgICAgZGVmYXVsdDogMwogICAgICAt\
IG5hbWU6IG15c3FsX2RhdGFiYXNlCiAgICAgICAgZGVzY3JpcHRpb246IFRoZSBuYW1lIG9mIHRo\
ZSBNeVNRTCBkYXRhYmFzZQogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIGRlZmF1bHQ6IHNh\
bXBsZQogICAgICAgIHBhdHRlcm46ICJeW2EtekEtWjAtOV9dKlthLXpBLVpfXStbYS16QS1aMC05\
X10qJCIKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIG5hbWU6IG15c3FsX3VzZXIKICAg\
ICAgICBkZXNjcmlwdGlvbjogVXNlcm5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gY29ubmVjdCB0\
byBNeVNRTAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHBhdHRlcm46ICJeW2EtekEtWjAt\
OV9dKlthLXpBLVpfXStbYS16QS1aMC05X10qJCIKICAgICAgICBkZWZhdWx0OiBhZG1pbgogICAg\
ICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gbmFtZTogbXlzcWxfcGFzc3dvcmQKICAgICAgICBk\
ZXNjcmlwdGlvbjogUGFzc3dvcmQgdG8gY29ubmVjdCB0byBNeVNRTCAoZ2VuZXJhdGVkIGlmIGJs\
YW5rKQogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAg\
ZGlzcGxheV90eXBlOiBwYXNzd29yZAogICAgICAgIGRlZmF1bHQ6IGFkbWluCiAgICAgIC0gbmFt\
ZTogdm9sdW1lX3NpemUKICAgICAgICB0eXBlOiBlbnVtCiAgICAgICAgZGVmYXVsdDogJzFHaScK\
ICAgICAgICBlbnVtOiBbJzFHaScsICc1R2knLCAnMTBHaSddCiAgICAgICAgdGl0bGU6IE15U1FM\
IFZvbHVtZSBTaXplCiAgICAgICAgcmVxdWlyZWQ6IHRydWU="


#RUN yum install -y iptables && yum clean all

ENV APB_ACTION_PATH="galera-ansible/playbooks/main.yml"
COPY roles /opt/ansible/roles
COPY requirements.yml /opt/ansible/requirements.yml
COPY inventory /etc/ansible/hosts
COPY playbooks /opt/apb/actions

RUN ansible-galaxy -vv install -r /opt/ansible/requirements.yml
RUN chmod -R g=u /opt/{ansible,apb} /etc/ansible/roles

USER apb


